{% extends "layout.html" %}
{% block content %}

<div class="admin-container">
    
    <!-- Admin Header -->
    <header class="admin-header">
        <h1 class="admin-title">
            <span class="icon">üìä</span>
            Admin Dashboard
        </h1>
        <div class="admin-actions">
            <button id="toggleLang" class="btn outline btn-sm">
                üåê <span id="langText">Switch to Urdu</span>
            </button>
            <button id="exportData" class="btn outline btn-sm">
                üíæ Export Data
            </button>
        </div>
    </header>

    <!-- Filters Section -->
    <section class="dashboard-card filters-section">
        <h2 class="card-title">
            <span class="icon">üîç</span>
            Filters
        </h2>
        
        <div class="filters-grid">
            <div class="filter-item">
                <label for="dateFrom">Date From:</label>
                <input type="date" id="dateFrom" class="filter-input">
            </div>
            
            <div class="filter-item">
                <label for="dateTo">Date To:</label>
                <input type="date" id="dateTo" class="filter-input">
            </div>
            
            <div class="filter-item">
                <label for="languageFilter">Language:</label>
                <select id="languageFilter" class="filter-input">
                    <option value="">All</option>
                    <option value="Python">Python</option>
                    <option value="Java">Java</option>
                </select>
            </div>
            
            <div class="filter-item">
                <label for="severityFilter">Severity:</label>
                <select id="severityFilter" class="filter-input">
                    <option value="">All</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            
            <div class="filter-item">
                <label for="userFilter">User:</label>
                <input type="text" id="userFilter" class="filter-input" placeholder="Username">
            </div>
            
            <div class="filter-item filter-actions">
                <button id="applyFilters" class="btn primary btn-sm">Apply Filters</button>
                <button id="resetFilters" class="btn outline btn-sm">Reset</button>
            </div>
        </div>
    </section>

    <!-- Statistics Cards -->
    <section class="stats-section">
        <div class="stats-grid">
            
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-content">
                    <h3 class="stat-value" id="totalSubmissions">-</h3>
                    <p class="stat-label">Total Submissions</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-content">
                    <h3 class="stat-value" id="avgQuality">-</h3>
                    <p class="stat-label">Avg Quality Score</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üêõ</div>
                <div class="stat-content">
                    <h3 class="stat-value" id="totalBugs">-</h3>
                    <p class="stat-label">Total Bugs Found</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <h3 class="stat-value" id="avgComplexity">-</h3>
                    <p class="stat-label">Avg Complexity</p>
                </div>
            </div>
            
        </div>
    </section>

    <!-- Charts Section -->
    <div class="charts-container">
        
        <!-- Language Distribution -->
        <section class="dashboard-card chart-section">
            <h2 class="card-title">
                <span class="icon">üìä</span>
                Submissions by Language
            </h2>
            <div id="languageChart" class="chart-content">
                <canvas id="langCanvas"></canvas>
            </div>
        </section>

        <!-- Quality Distribution -->
        <section class="dashboard-card chart-section">
            <h2 class="card-title">
                <span class="icon">üéØ</span>
                Quality Distribution
            </h2>
            <div id="qualityChart" class="chart-content">
                <canvas id="qualityCanvas"></canvas>
            </div>
        </section>

    </div>

    <!-- Bug Statistics -->
    <section class="dashboard-card bugs-section">
        <h2 class="card-title">
            <span class="icon">üêû</span>
            Top Bugs
        </h2>
        
        <div id="bugsList" class="bugs-list">
            <div class="loading">Loading bug statistics...</div>
        </div>
    </section>

    <!-- Recent Submissions Table -->
    <section class="dashboard-card table-section">
        <h2 class="card-title">
            <span class="icon">üìã</span>
            Recent Submissions
        </h2>
        
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Language</th>
                        <th>User</th>
                        <th>Quality</th>
                        <th>Level</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="submissionsTable">
                    <tr>
                        <td colspan="6" class="loading">Loading submissions...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

</div>

<style>
/* Admin-specific styles */
.admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--space-6);
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-8);
}

.admin-title {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--text-primary);
    margin: 0;
}

.admin-actions {
    display: flex;
    gap: var(--space-3);
}

.filters-section {
    margin-bottom: var(--space-6);
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    align-items: end;
}

.filter-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.filter-item label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--text-secondary);
}

.filter-input {
    padding: var(--space-3);
    border-radius: var(--border-radius-md);
    border: 1px solid var(--border-primary);
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
}

.filter-actions {
    display: flex;
    gap: var(--space-2);
}

.stats-section {
    margin-bottom: var(--space-6);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: var(--space-4);
}

.stat-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-6);
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--border-primary);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    font-size: 3rem;
}

.stat-value {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--accent-primary);
    margin: 0;
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--text-muted);
    margin: 0;
}

.charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-6);
}

.chart-section {
    min-height: 300px;
}

.chart-content {
    padding: var(--space-4);
}

.bugs-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.bug-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    background: var(--bg-secondary);
    border-radius: var(--border-radius-md);
    border: 1px solid var(--border-primary);
}

.bug-description {
    flex: 1;
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.bug-count {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--accent-primary);
}

.table-wrapper {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: var(--bg-tertiary);
    padding: var(--space-4);
    text-align: left;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--text-secondary);
    border-bottom: 2px solid var(--border-primary);
}

.data-table td {
    padding: var(--space-4);
    border-bottom: 1px solid var(--border-primary);
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.data-table tbody tr:hover {
    background: var(--bg-secondary);
}

.loading {
    text-align: center;
    padding: var(--space-8);
    color: var(--text-muted);
}

@media (max-width: 768px) {
    .admin-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-4);
    }
    
    .filters-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-container {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Admin dashboard JavaScript
let currentLanguage = 'en';

document.addEventListener('DOMContentLoaded', () => {
    loadAdminStats();
    
    // Event listeners
    document.getElementById('applyFilters').addEventListener('click', applyFilters);
    document.getElementById('resetFilters').addEventListener('click', resetFilters);
    document.getElementById('toggleLang').addEventListener('click', toggleLanguage);
    document.getElementById('exportData').addEventListener('click', exportData);
});

// Fixed admin dashboard JavaScript - Add this to your admin.html

async function loadAdminStats(filters = {}) {
    try {
        const params = new URLSearchParams(filters);
        const response = await fetch(`/api/admin/stats?${params}`, {
            method: 'GET',
            credentials: 'same-origin',  // Important: include session cookies
            headers: {
                'X-Requested-With': 'XMLHttpRequest'  // Mark as AJAX request
            }
        });
        
        // Check if we got redirected to login
        if (response.status === 401) {
            const data = await response.json();
            if (data.redirect) {
                window.location.href = data.redirect;
            } else {
                window.location.href = '/login';
            }
            return;
        }
        
        if (!response.ok) {
            throw new Error('Failed to load statistics');
        }
        
        const data = await response.json();
        
        // Update statistics cards
        updateStatistics(data.submission_stats, data.bug_stats);
        
        // Update charts
        updateCharts(data.submission_stats);
        
        // Update bugs list
        updateBugsList(data.bug_stats);
        
        // Update submissions table
        updateSubmissionsTable(data.recent_submissions);
        
    } catch (error) {
        console.error('Error loading admin stats:', error);
        // Don't redirect on error, just show error message
        const statsCards = document.querySelectorAll('.stat-value');
        statsCards.forEach(card => {
            card.textContent = 'Error';
        });
    }
}

// Also update the exportData function
async function exportData() {
    try {
        const response = await fetch('/api/admin/export?format=json', {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.status === 401) {
            window.location.href = '/login';
            return;
        }
        
        if (!response.ok) {
            throw new Error('Export failed');
        }
        
        // Trigger download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `codeai_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
    } catch (error) {
        console.error('Export error:', error);
        alert('Failed to export data: ' + error.message);
    }
}
function updateStatistics(submissionStats, bugStats) {
    document.getElementById('totalSubmissions').textContent = 
        submissionStats.total_submissions || 0;
    
    document.getElementById('avgQuality').textContent = 
        `${submissionStats.avg_overall_score || 0}%`;
    
    document.getElementById('totalBugs').textContent = 
        bugStats.total_bugs || 0;
    
    document.getElementById('avgComplexity').textContent = 
        `${submissionStats.avg_complexity || 0}%`;
}

function updateCharts(stats) {
    // Language distribution chart
    const langData = stats.by_language || {};
    const langLabels = Object.keys(langData);
    const langCounts = langLabels.map(lang => langData[lang].count);
    
    // Quality distribution chart
    const qualityData = stats.quality_distribution || {};
    const qualityLabels = Object.keys(qualityData);
    const qualityCounts = qualityLabels.map(level => qualityData[level]);
    
    // Simple text-based charts (you can integrate Chart.js here)
    document.getElementById('languageChart').innerHTML = `
        <div class="simple-chart">
            ${langLabels.map((lang, i) => `
                <div class="chart-bar">
                    <span>${lang}</span>
                    <div class="bar" style="width: ${langCounts[i] * 10}%"></div>
                    <span>${langCounts[i]}</span>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('qualityChart').innerHTML = `
        <div class="simple-chart">
            ${qualityLabels.map((level, i) => `
                <div class="chart-bar">
                    <span>${level}</span>
                    <div class="bar" style="width: ${qualityCounts[i] * 10}%"></div>
                    <span>${qualityCounts[i]}</span>
                </div>
            `).join('')}
        </div>
    `;
}

function updateBugsList(bugStats) {
    const topBugs = bugStats.top_bugs || [];
    const bugsList = document.getElementById('bugsList');
    
    if (topBugs.length === 0) {
        bugsList.innerHTML = '<div class="loading">No bugs found</div>';
        return;
    }
    
    bugsList.innerHTML = topBugs.map(bug => `
        <div class="bug-item">
            <div class="bug-description">${bug.description}</div>
            <div class="bug-count">${bug.count}</div>
        </div>
    `).join('');
}

function updateSubmissionsTable(submissions) {
    const tbody = document.getElementById('submissionsTable');
    
    if (submissions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">No submissions found</td></tr>';
        return;
    }
    
    tbody.innerHTML = submissions.map(sub => {
        const date = new Date(sub.timestamp).toLocaleDateString();
        const quality = sub.scores?.overall || 0;
        const level = sub.scores?.quality_level || 'N/A';
        
        return `
            <tr>
                <td>${sub.filename}</td>
                <td>${sub.language}</td>
                <td>${sub.username}</td>
                <td>${quality}%</td>
                <td><span class="badge badge-${level.toLowerCase()}">${level}</span></td>
                <td>${date}</td>
            </tr>
        `;
    }).join('');
}

function applyFilters() {
    const filters = {
        start_date: document.getElementById('dateFrom').value,
        end_date: document.getElementById('dateTo').value,
        language: document.getElementById('languageFilter').value,
        severity: document.getElementById('severityFilter').value,
        user: document.getElementById('userFilter').value
    };
    
    // Remove empty filters
    Object.keys(filters).forEach(key => {
        if (!filters[key]) delete filters[key];
    });
    
    loadAdminStats(filters);
}

function resetFilters() {
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('languageFilter').value = '';
    document.getElementById('severityFilter').value = '';
    document.getElementById('userFilter').value = '';
    
    loadAdminStats();
}

function toggleLanguage() {
    currentLanguage = currentLanguage === 'en' ? 'ur' : 'en';
    const langText = document.getElementById('langText');
    langText.textContent = currentLanguage === 'en' ? 'Switch to Urdu' : 'Switch to English';
    
    // TODO: Implement language switching for UI elements
    console.log('Language switched to:', currentLanguage);
}

async function exportData() {
    try {
        window.location.href = '/api/admin/export?format=json';
    } catch (error) {
        console.error('Export error:', error);
        showError('Failed to export data');
    }
}

function showError(message) {
    // Simple error display - you can enhance this
    alert(message);
}
</script>

{% endblock %}